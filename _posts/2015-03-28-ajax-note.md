---
layout: post
title: Ajax-note
categories: 
- tech

tags: 
- note
- Ajax
- JavaScript

time: 2015-03-28 10:20:56
excerpt: JavaScript原生Ajax学习笔记

---

## Ajax_原理和封装

### Ajax原理

ajax : Asynchronous JavaScript and XML 异步JavaScript和XML

用javascript异步形式去操作xml

简单的ajax应用：

{% highlight javascript %}
window.onload = function() {
    var oBtn = document.getElementById('btn');
    
    oBtn.onclick = function() {
        //打开浏览器
        var xhr = new XMLHttpRequest();

        //在地址栏输入地址
        xhr.open('get','1.txt',true);
        //提交
        xhr.send();
        //等待服务器返回内容
        xhr.onreadystatechange = function() {
            if ( xhr.readyState == 4 ) {
                alert( xhr.responseText );
            }
        }
    }
}
{% endhighlight %}

### 对象的创建和兼容处理

{% highlight javascript %}
window.onload = function() {
    var oBtn = document.getElementById('btn');
    
    oBtn.onclick = function() {
        //打开浏览器
        /*
            1.创建一个ajax对象
                ie6一下不支持XMLHttpRequest对象
                ie6以下new ActiveXObject('Microsoft.XMLHTTP')(ie6中的插件形式)
        */
        var xhr = null;
        /* 处理兼容性问题1
            if (window.XMLHttpRequest) {
                xhr = new XMLHttpRequest();
            } else {
                xhr = new ActiveXObject('Microsoft.XMLHTTP');
            }
        */
        // 处理兼容性问题2-更好的方式（不会终止程序运行）
        try {
            xhr = new XMLHttpRequest();
            // throw new Error('错了'); 手动抛错
        } catch (e) {
            xhr = new ActiveXObject('Microsoft.XMLHTTP');
        }

        //在地址栏输入地址
        /*
            open方法
            参数
                1.打开方式
                2.地址
                3.是否异步
                    异步:非阻塞 前面的代码不会影响后面代码的执行，（onreadystatechange协作）
                    同步:阻塞 前面的代码会影响后面代码的执行（少用）
        */
        xhr.open('get','1.txt',true);// 准备工作
        //提交
        xhr.send();
        
        //等待服务器返回内容
        /*
            readyState : ajax工作状态
            responseText : ajax请求返回的内容就被存放到这个属性下面
            onreadystatechange : 当readyState改变的时候触发
            status : 服务器状态，http状态码
        */
        xhr.onreadystatechange = function() {
            if ( xhr.readyState == 4 ) {
                if ( xhr.status == 200 ) {
                    alert( xhr.responseText );// 字符串形式
                } else {
                    alert('出错了,Err：' + xhr.status);// 弹出错误情况
                }
            }
        }
    }
}
{% endhighlight %}

### open方法和表单

表单提交的方式：

{% highlight html %}
<body>
    <!-- 
        表单：数据的提交
        action : 数据提交的地址，默认是当前页面
        method : 数据提交的方式，默认是get方式
            1.get
                把数据名称和数据值用=连接，如果有多个的话，那么他会把多个数据组合用&进行连接，然后把数据放到url?后面传到指定页面
                url长度限制，大小因浏览器不同而不同
                显式：不安全
            2.post
                理论上无限制
        enctype : 提交的数据格式，默认application/x-www-form-urlencoded 
    -->
    <form action="1.get.php" enctype="application/x-www-form-urlencoded">
        <input type="text" name="username" />
        <input type="text" name="age" />
        <input type="submit" value="提交" />
    </form>
</body>
{% endhighlight %}

后台数据的获取：

{% highlight php %}
// get方式
header('content-type:text/html;charset="utf-8"');
error_reporting(0);

$username = $_GET['username'];
$age = $_GET['age'];

echo "你的名字：{$username}，年龄：{$age}";
?>
{% endhighlight %}

{% highlight php %}
// post方式
header('content-type:text/html;charset="utf-8"');
error_reporting(0);

$username = $_POST['username'];
$age = $_POST['age'];

echo "你的名字：{$username}，年龄：{$age}";
{% endhighlight %}

### 返回内容的获取

触发onreadystatechange，通过处理xhr.readyState的状态码来处理请求

readyState的状态码：

* 0（初始化）还没有调用open()方法
* 1（载入）已调用send()方法，正在发送请求
* 2（载入完成）send()方法完成，已收到全部响应内容
* 3（解析）正在解析响应内容
* 4（完成）响应内容解析完成，可以在客户端调用了

<a href="http://baike.baidu.com/view/1790469.htm" rel="nofollow">HTTP状态码</a>

### ajax获取数据的处理和实例

后台

{% highlight php %}
header('content-type:text/html;charset="utf-8"');
error_reporting(0);

$arr1 = array('leo','momo','zhangsen');

/*$arr2 = array('username'=>'leo','age'=>32);*/
/* echo array; 不好，没有经过处理*/ 

echo json_encode($arr1);// 格式化数组
{% endhighlight %}

前端用JSON官网提供的JSON.js进行处理<a href="http://json.org/">json</a>

{% highlight javascript %}
/*
JSON : 
*/

//alert(JSON)

//stringify : 可以把一个对象转成对应字符串

var arr = [1,2,3];
var j = {left:100};
/*alert( JSON.stringify(arr) );*/
/*alert( JSON.stringify(j) );*/

//parse : 可以把字符串转成对应对象
var s1 = '[100,200,300]';
var a1 = JSON.parse(s1);
//alert(a1[0])

var s2 = '{"left":100}';
var a2 = JSON.parse(s2);
alert(a2.left);
{% endhighlight %}

### 实例应用：新闻类

后台：getNews.php

{% highlight php %}
header('content-type:text/html;charset="utf-8"');
error_reporting(0);

$news = array(
    array('title'=>'德国女总理默克尔滑雪时摔倒 骨盆断裂','date'=>'2014-1-6'),
    array('title'=>'中日驻英外交官撰文互称对方国家为"伏地魔"','date'=>'2014-1-6'),
    array('title'=>'安倍:望与中国领导人会面 中方:你关闭了大门','date'=>'2014-1-6'),
    array('title'=>'揭秘台湾驻港间谍网运作 湖北宜昌副市长被查','date'=>'2014-1-6'),
    array('title'=>'习近平：嫦娥三号是货真价实的中国创造','date'=>'2014-1-6'),
    array('title'=>'习近平：嫦娥三号是货真价实的中国创造','date'=>'2014-1-6'),
    array('title'=>'习近平：嫦娥三号是货真价实的中国创造','date'=>'2014-1-6'),
    array('title'=>'习近平：嫦娥三号是货真价实的中国创造','date'=>'2014-1-6'),
    array('title'=>'习近平：嫦娥三号是货真价实的中国创造','date'=>'2014-1-6'),
    array('title'=>'中国长达13年游戏机禁令正式解除 外企可进入','date'=>'2014-1-6'),
    array('title'=>'70种证件伴中国人一生:领养老金要办生存证明','date'=>'2014-1-6'),
    array('title'=>'德国女总理默克尔滑雪时摔倒 骨盆断裂','date'=>'2014-1-6'),
    array('title'=>'中日驻英外交官撰文互称对方国家为"伏地魔"','date'=>'2014-1-6'),
    array('title'=>'安倍:望与中国领导人会面 中方:你关闭了大门','date'=>'2014-1-6'),
    array('title'=>'揭秘台湾驻港间谍网运作 湖北宜昌副市长被查','date'=>'2014-1-6'),
);

echo json_encode($news);
{% endhighlight %}

前端：news.html

封装ajax: ajax.js

{% highlight javascript %}
function ajax(method, url, data, success) {
    var xhr = null;
    try {
        xhr = new XMLHttpRequest();
    } catch (e) {
        xhr = new ActiveXObject('Microsoft.XMLHTTP');
    }
    
    if (method == 'get' && data) {
        url += '?' + data;
    }
    
    xhr.open(method,url,true);
    if (method == 'get') {
        xhr.send();
    } else {
        // 处理post请求
        xhr.setRequestHeader('content-type', 'application/x-www-form-urlencoded');
        xhr.send(data);
    }
    
    xhr.onreadystatechange = function() {
        if ( xhr.readyState == 4 ) {
            if ( xhr.status == 200 ) {
                success && success(xhr.responseText);
            } else {
                alert('出错了,Err：' + xhr.status);
            }
        }
    }
}
{% endhighlight %}

{% highlight html %}
<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>无标题文档</title>
<script src="ajax.js"></script>
<script>
window.onload = function() {
    
    var oBtn = document.getElementById('btn');
    
    
    oBtn.onclick = function() {
        
        // jquery 的做法
        /*ajax({
            url :   'getNews.php',
            success : function(data) {
                //...
            }
        });*/
        
        ajax('get','getNews.php','',function(data) {
            var data = JSON.parse( data );
                
            var oUl = document.getElementById('ul1');
            var html = '';
            for (var i=0; i<data.length; i++) {
                html += '<li><a href="">'+data[i].title+'</a> [<span>'+data[i].date+'</span>]</li>';
            }
            oUl.innerHTML = html;
        });
        
        // 动态刷新
        setInterval(function() {
            ajax('get','getNews.php','',function(data) {
                var data = JSON.parse( data );
                    
                var oUl = document.getElementById('ul1');
                var html = '';
                for (var i=0; i<data.length; i++) {
                    html += '<li><a href="">'+data[i].title+'</a> [<span>'+data[i].date+'</span>]</li>';
                }
                oUl.innerHTML = html;
            });
        }, 1000);
    }
}
</script>
</head>
<body>
    <input type="button" value="按钮" id="btn" />
    <ul id="ul1"></ul>
</body>
</html>
{% endhighlight %}

## Ajax_实例：留言板、瀑布流（固定列的瀑布流）

### 瀑布流布局原理

{% highlight html %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ajax瀑布流</title>
    <style>
    body{margin: 0;padding: 0;}
    ul,li{list-style: none;padding: 0;margin: 0;}
    #outer{width: 1000px;margin: 0 auto;}
    li{width: 232px;float: left;}
    li div{padding: 10px;margin: 5px;border: 1px solid #e7e7e7;box-shadow: 0 0 1px 1px #e7e7e7;}
    img{width: 200px;}
    </style>
</head>
<body>
    <!-- 图片来自百度 -->
    <div id="outer">
        <ul>
            <li>
                <div>
                    <img src="http://e.hiphotos.baidu.com/image/w%3D310/sign=ecf4260c249759ee4a5066ca82fb434e/d439b6003af33a870d5e421bc45c10385343b584.jpg" alt="">
                    <p>新鲜,白干酪,全麦,面包</p>
                </div>
                <!-- 在最短的li中添加下一个块 -->
                <div>
                    <img src="http://a.hiphotos.baidu.com/image/w%3D310/sign=4d72b8f4b6fb43161a1f7c7b10a44642/e850352ac65c1038235c16fdb6119313b07e89eb.jpg" alt="">
                    <p>“国家摄影《眼睛》迎300期摄影大赛”《留</p>
                </div>
            </li>
            <li>
                <div>
                    <img src="http://b.hiphotos.baidu.com/image/w%3D310/sign=059daeaca6c27d1ea5263dc52bd4adaf/78310a55b319ebc466e76a918026cffc1e17161e.jpg" alt="">
                    <p>水下摄影</p>
                </div>
            </li>
            <li>
                <div>
                    <img src="http://h.hiphotos.baidu.com/image/w%3D310/sign=f58c8dd1ea50352ab16123096342fb1a/d4628535e5dde7115f90c190a4efce1b9d166112.jpg" alt="">
                    <p>人像 CNdY 5447</p>
                </div>
            </li>
            <li>
                <div>
                    <img src="http://g.hiphotos.baidu.com/image/w%3D310/sign=f0be4958f4246b607b0eb475dbf91a35/b3b7d0a20cf431ad855854324936acaf2edd9836.jpg" alt="">
                    <p>标签:水下摄影</p>
                </div>
            </li>
        </ul>
    </div>
</body>
</html>
{% endhighlight %}

### 数据的分析及添加

获取最短的li：

{% highlight javascript %}
function getShort() {
    var index = 0;
    var ih = aLi[index].offsetHeight;
    for (var i=1; i<iLen; i++) {
        if ( aLi[i].offsetHeight < ih ) {
            index = i;
            ih = aLi[i].offsetHeight;
        }
    }
    return index;
}
{% endhighlight %}

bug: 当某些图片的长度过长时，因为图片还没被加载，li的高度没有增加，所以会出现重复添加到同一个li中的问题

解决方式：

* 后台数据配合给出图片的宽与高，前端计算后预先加入图片的属性中
* 图片预加载功能处理（更好）

第二种方式：

{% highlight javascript %}
for ( var i=0; i<data.length; i++ ) {
    
    //获取高度最短的li
    var _index = getShort();
    
    var oDiv = document.createElement('div');
    var oImg = document.createElement('img');
    oImg.src = data[i].preview;
    // 固定宽度同时计算高度预设值
    oImg.style.width = '200px';
    oImg.style.height =  data[i].height * ( 200 / data[i].width ) + 'px';
    
    oDiv.appendChild( oImg );
    var oP = document.createElement('p');
    oP.innerHTML = data[i].title;
    oDiv.appendChild( oP );
    
    aLi[_index].appendChild( oDiv );
}
{% endhighlight %}

利用上一节封装的ajax.js做数据初始化：

{% highlight javascript %}

function getList() {
    // 通过iPage控制页索引
    ajax('get','getPics.php','cpage=' + iPage,function(data) {
        var data = JSON.parse(data);
        
        for ( var i=0; i<data.length; i++ ) {
            
            //获取高度最短的li
            var _index = getShort();
            
            var oDiv = document.createElement('div');
            var oImg = document.createElement('img');
            oImg.src = data[i].preview;
            oImg.style.width = '200px';
            oImg.style.height =  data[i].height * ( 200 / data[i].width ) + 'px';
            oDiv.appendChild( oImg );
            var oP = document.createElement('p');
            oP.innerHTML = data[i].title;
            oDiv.appendChild( oP );
            
            aLi[_index].appendChild( oDiv );
        }
    });
}
{% endhighlight %}

getPics.php

{% highlight php %}
header('Content-type:text/html; charset="utf-8"');

/*
API:
    getPics.php

        参数
        cpage : 获取数据的页数
*/
$cpage = isset($_GET['cpage']) ? $_GET['cpage'] : 1;

$url = 'http://www.wookmark.com/api/json/popular?page=' . $cpage;

$content = file_get_contents($url);
$content = iconv('gbk', 'utf-8', $content);

echo $content;
{% endhighlight %}

滚动条事件控制：

{% highlight javascript %}
// 滚动事件
window.onscroll = function() {
    
    var _index = getShort();
    var oLi = aLi[_index];
    
    var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
    
    if ( getTop( oLi ) + oLi.offsetHeight < document.documentElement.clientHeight + scrollTop ) {
            iPage++;
            getList();        
    }
}

// 获取一个元素到页面的绝对值
function getTop(obj) {
    var iTop = 0;
    while(obj) {
        iTop += obj.offsetTop;
        obj = obj.offsetParent;
    }
    return iTop;
}
{% endhighlight %}

而此时也会有bug：滚动条的重复触发事件，因此要设置开关，完整代码如下：

{% highlight javascript %}
// 要导入ajax.js
window.onload = function() {
    
    var aLi = document.getElementsByTagName('li');
    var iLen = aLi.length;
    var iPage = 1;
    var b = true;// 控制页面是否完结
    
    //初始化数据处理
    getList();
    
    function getList() {
        ajax('get','getPics.php','cpage=' + iPage,function(data) {
            var data = JSON.parse(data);
            
            if ( !data.length ) {
                //后续没有数据了
                return ;
            }
            
            for ( var i=0; i<data.length; i++ ) {
                
                //获取高度最短的li
                var _index = getShort();
                
                var oDiv = document.createElement('div');
                var oImg = document.createElement('img');
                oImg.src = data[i].preview;
                oImg.style.width = '200px';
                oImg.style.height =  data[i].height * ( 200 / data[i].width ) + 'px';
                oDiv.appendChild( oImg );
                var oP = document.createElement('p');
                oP.innerHTML = data[i].title;
                oDiv.appendChild( oP );
                
                aLi[_index].appendChild( oDiv );
                
            }
            
            b = true;
            
        });
    }
    
    // 滚动事件
    window.onscroll = function() {
        
        var _index = getShort();
        var oLi = aLi[_index];
        
        var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        
        if ( getTop( oLi ) + oLi.offsetHeight < document.documentElement.clientHeight + scrollTop ) {
            
            // 控制滚动条多次触发时的bug
            if ( b ) {
                b = false;
                iPage++;
                getList();
            }
            
        }
        
    }
    
    function getShort() {
        var index = 0;
        var ih = aLi[index].offsetHeight;
        for (var i=1; i<iLen; i++) {
            if ( aLi[i].offsetHeight < ih ) {
                index = i;
                ih = aLi[i].offsetHeight;
            }
        }
        return index;
    }
    
    // 获取一个元素到页面的绝对值
    function getTop(obj) {
        var iTop = 0;
        while(obj) {
            iTop += obj.offsetTop;
            obj = obj.offsetParent;
        }
        return iTop;
    }
    
}
{% endhighlight %}



